## Eleven Labs Direct Tools - Medical System Tools

Use this document to create Client Tools in Eleven Labs for the medical system. These tools provide complete functionality for patient data management, appointment booking, and call logging.

### Base Endpoint
- Execute any tool directly via webhook: `POST {AI_AGENT_SERVER_URL}/api/elevenlabs/tools/execute`
  - Body: `{ toolName: string, parameters: object, conversationId?: string, metadata: { businessId: string, locationId: string } }`

---

## Tool 1: query_resources
**Purpose**: Query medical resources (patients, treatments, medics) using existing /resources endpoint

### Resource Types:
- `patient` - Search patients by name
- `treatment` - List treatments by type
- `medic` - Search doctors by name

### Example Payloads:

#### Search Patients:
```json
{
  "businessId": "B0100001",
  "locationId": "L0100001",
  "resourceType": "patient",
  "action": "list",
  "params": { "data.patientName": "Ion Popescu" }
}
```

#### List Treatments:
```json
{
  "businessId": "B0100001",
  "locationId": "L0100001",
  "resourceType": "treatment",
  "action": "list",
  "params": { "data.treatmentType": "dentistry" }
}
```

#### Search Doctors:
```json
{
  "businessId": "B0100001",
  "locationId": "L0100001",
  "resourceType": "medic",
  "action": "list",
  "params": { "data.medicName": "Popescu" }
}
```

**Recommended tool name in Eleven Labs**: `query_resources`

---

## Tool 2: query_patient_booking
**Purpose**: Manage patient appointments using existing booking endpoints

### Actions Supported:
- `available-dates-with-slots` - Check available appointment slots
- `reserve` - Create new appointment
- `cancel-appointment` - Cancel existing appointment

### Example Payloads:

#### Check Availability:
```json
{
  "businessId": "B0100001",
  "locationId": "L0100001",
  "action": "available-dates-with-slots",
  "params": { "from": "2024-12-01", "to": "2024-12-31", "serviceId": "T0100001", "medicId": "M0100001" }
}
```

#### Create Appointment:
```json
{
  "businessId": "B0100001",
  "locationId": "L0100001",
  "action": "reserve",
  "params": {
    "date": "2024-12-15",
    "time": "10:30",
    "serviceId": "T0100001",
    "medicId": "M0100001",
    "duration": 30,
    "customer": { "name": "Ion Popescu", "email": "ion@example.com", "phone": "0712345678" }
  }
}
```

#### Cancel Appointment:
```json
{
  "businessId": "B0100001",
  "locationId": "L0100001",
  "action": "cancel-appointment",
  "params": { "appointmentId": "A0100123", "patientId": "P010045", "accessCode": "123456" }
}
```

**Recommended tool name in Eleven Labs**: `query_patient_booking`

---

## Tool 3: log_call_completion
**Purpose**: Log completed voice calls with metadata (automatically called by ElevenLabs)

### Automatic Call Logging:
This tool is automatically invoked by ElevenLabs when a call ends, providing:
- Call duration and cost
- Complete transcript
- Call status and metadata
- Business and location context

### Example Payload (Auto-generated by ElevenLabs):
```json
{
  "businessId": "B0100001",
  "locationId": "L0100001",
  "conversationId": "conv_abc456",
  "callDuration": 180,
  "cost": 350,
  "startTime": 1739537297,
  "status": "completed",
  "transcript": [
    {
      "role": "agent",
      "message": "Bună ziua! Cum vă pot ajuta?",
      "timeInCallSecs": 0
    },
    {
      "role": "user",
      "message": "Vreau o programare pentru mâine.",
      "timeInCallSecs": 5
    }
  ],
  "metadata": {
    "callType": "appointment_booking",
    "outcome": "successful_booking",
    "appointmentCreated": true
  }
}
```

**Recommended tool name in Eleven Labs**: `log_call_completion`

---


---

## Tool Configuration

### Tool IDs per businessType
After creating the tools in Eleven Labs Dashboard, provide the tool IDs for each business type:

```json
{
  "dental": {
    "query_resources": "{TOOL_ID_resources}",
    "query_patient_booking": "{TOOL_ID_booking}",
    "log_call_completion": "{TOOL_ID_logging}"
  },
  "gym": {
    "query_resources": "{TOOL_ID_resources}",
    "query_patient_booking": "{TOOL_ID_booking}",
    "log_call_completion": "{TOOL_ID_logging}"
  },
  "hotel": {
    "query_resources": "{TOOL_ID_resources}",
    "query_patient_booking": "{TOOL_ID_booking}",
    "log_call_completion": "{TOOL_ID_logging}"
  }
}
```

### Activate Tools on Agent
After creating tools in Eleven Labs, activate them on the agent:

```bash
POST /api/elevenlabs/activate/{businessId}-{locationId}
Content-Type: application/json

{
  "toolIds": [
    "{TOOL_ID_resources}",
    "{TOOL_ID_booking}",
    "{TOOL_ID_logging}"
  ]
}
```

### Webhook Configuration
Configure the call completion webhook in Eleven Labs Dashboard:

```
Event Type: post_call_transcription
URL: {AI_AGENT_SERVER_URL}/api/elevenlabs/webhook
```

The service will attach all `tool_ids` to the agent's configuration on creation.

---

## Implementation Summary

These 3 tools provide complete medical system functionality using existing endpoints:

1. ✅ **query_resources** - Access patients, treatments, medics via `/resources/{businessId}-{locationId}` with `X-Resource-Type` header
2. ✅ **query_patient_booking** - Manage appointments via existing booking endpoints (`available-dates-with-slots`, `reserve`, `cancel-appointment`)
3. ✅ **log_call_completion** - Automatic call logging with metadata

All tools integrate with the existing system architecture and use the current API endpoints without modifications.


