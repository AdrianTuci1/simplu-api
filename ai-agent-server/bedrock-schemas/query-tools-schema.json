{
  "openapi": "3.0.0",
  "info": {
    "title": "Query Tools API",
    "version": "1.3.0",
    "description": "Read-only queries for business data with support for nested field searches and complex filters"
  },
  "paths": {
    "/query_resources": {
      "post": {
        "summary": "Query resources (operators) via /api/resources",
        "description": "READ-ONLY queries for all resource types. Supports:\n\n**Resource Types:** appointment, patient, treatment, medic, service, setting, plan, dental-chart\n\n**Actions:**\n- list: Get multiple resources with filters\n- get: Get single resource by resourceId\n\n**Nested Field Search:**\nYou can filter by nested fields using dot notation in params:\n\n**For appointments:**\n- data.patient.name - Patient name in appointment\n- data.patient.id - Patient ID in appointment  \n- data.doctor.name or data.medic.name - Doctor/Medic name in appointment\n- data.services[].name - Service/treatment name (NEW structure - array)\n- data.service.name - Service name (backward compatibility - old structure)\n- data.status - Appointment status (scheduled, confirmed, completed, cancelled, no_show)\n- startDate/endDate - Date range filters (TOP-LEVEL, not in data.*)\n\n**For patients:**\n- data.patientName - Patient full name\n- data.patientPhone - Patient phone number\n- data.patientEmail - Patient email\n\n**For plans (treatment plans):**\n- data.patientId - Patient ID (REQUIRED - cannot search by name directly)\n- data.status - Plan status (draft, proposed, accepted, in_progress, completed, cancelled)\n\n**For dental-chart:**\n- data.patientId - Patient ID (REQUIRED - cannot search by name directly)\n\n**For treatments/services:**\n- data.treatmentName - Treatment name\n- data.price - Treatment price\n- data.duration - Treatment duration\n\n**For medics:**\n- data.medicName - Medic name\n- data.userId - User ID linked to medic\n\n**IMPORTANT WORKFLOW for plans and dental-charts:**\n1. First query patient by name: resourceType=patient, params={data.patientName: 'Name'}\n2. Extract patientId from result\n3. Then query plan/chart: resourceType=plan, params={data.patientId: 'extracted_id'}\n\n**Search Features:**\n- Case-insensitive partial matching\n- Combine multiple filters\n- Date range support (startDate/endDate for appointments)\n- Sort and pagination support",
        "operationId": "query_resources",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["businessId", "locationId", "action", "resourceType"],
                "properties": {
                  "businessId": { 
                    "type": "string",
                    "description": "Business ID from context"
                  },
                  "locationId": { 
                    "type": "string",
                    "description": "Location ID from context"
                  },
                  "action": { 
                    "type": "string", 
                    "enum": ["list", "get"],
                    "description": "list for multiple resources, get for single resource by ID"
                  },
                  "resourceType": { 
                    "type": "string",
                    "description": "Resource type: appointment, patient, treatment, medic, service, setting, plan, dental-chart",
                    "enum": ["appointment", "patient", "treatment", "medic", "service", "setting", "plan", "dental-chart"]
                  },
                  "resourceId": { 
                    "type": "string",
                    "description": "Resource ID (required only for action=get)"
                  },
                  "params": { 
                    "type": "object",
                    "description": "Filter parameters using nested field notation (e.g., data.patientName, data.patient.name, data.status)",
                    "properties": {
                      "data.patientName": {
                        "type": "string",
                        "description": "For patient search"
                      },
                      "data.patient.name": {
                        "type": "string",
                        "description": "For appointment search by patient name"
                      },
                      "data.patientId": {
                        "type": "string",
                        "description": "For plan/dental-chart search by patient ID"
                      },
                      "data.status": {
                        "type": "string",
                        "description": "Status filter (appointment, plan)"
                      },
                      "startDate": {
                        "type": "string",
                        "description": "Start date for range (YYYY-MM-DD)"
                      },
                      "endDate": {
                        "type": "string",
                        "description": "End date for range (YYYY-MM-DD)"
                      }
                    }
                  }
                }
              },
              "examples": {
                "searchPatientByName": {
                  "summary": "Search patient by name",
                  "value": {
                    "businessId": "B0100001",
                    "locationId": "L0100001",
                    "action": "list",
                    "resourceType": "patient",
                    "params": {
                      "data.patientName": "Maria Ionescu"
                    }
                  }
                },
                "searchAppointmentsByPatient": {
                  "summary": "Search appointments by patient name",
                  "value": {
                    "businessId": "B0100001",
                    "locationId": "L0100001",
                    "action": "list",
                    "resourceType": "appointment",
                    "params": {
                      "data.patient.name": "Ion Popescu",
                      "startDate": "2025-10-14",
                      "endDate": "2025-10-20"
                    }
                  }
                },
                "getTreatmentPlanByPatientId": {
                  "summary": "Get treatment plan by patient ID (2-step workflow)",
                  "value": {
                    "businessId": "B0100001",
                    "locationId": "L0100001",
                    "action": "list",
                    "resourceType": "plan",
                    "params": {
                      "data.patientId": "P0100123",
                      "data.status": "accepted"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": { 
          "200": { 
            "description": "Successful query",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "data": {
                      "type": "array",
                      "description": "Array of resources matching the query"
                    },
                    "count": { 
                      "type": "number",
                      "description": "Total number of results"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/query_patient_booking": {
      "post": {
        "summary": "Patient booking operations",
        "description": "Complete patient booking system operations.\n\n**Actions:**\n- available-dates-with-slots: Get available dates with time slots (requires from, to params, optional: serviceId, medicId)\n- reserve: Create appointment booking (requires date, time, serviceId, customer object with name/email/phone, optional: medicId, duration)\n- cancel-appointment: Cancel patient appointment (requires appointmentId, patientId, accessCode)\n\n**Workflow Examples:**\n1. **New Booking:** available-dates-with-slots → patient selects → reserve\n2. **Check Availability:** available-dates-with-slots with serviceId/medicId filters\n3. **Cancel Booking:** cancel-appointment with patient credentials\n\n**Note:** For listing services/treatments, use query_resources with resourceType=treatment instead.",
        "operationId": "query_patient_booking",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["businessId", "locationId", "action", "params"],
                "properties": {
                  "businessId": { 
                    "type": "string",
                    "description": "Business ID from context"
                  },
                  "locationId": { 
                    "type": "string",
                    "description": "Location ID from context"
                  },
                  "action": { 
                    "type": "string", 
                    "enum": ["available-dates-with-slots", "reserve", "cancel-appointment"],
                    "description": "Action: available-dates-with-slots (query), reserve (create), cancel-appointment (cancel)"
                  },
                  "params": {
                    "type": "object",
                    "description": "Action-specific parameters",
                    "properties": {
                      "from": {
                        "type": "string",
                        "description": "Start date for available-dates-with-slots (YYYY-MM-DD)"
                      },
                      "to": {
                        "type": "string",
                        "description": "End date for available-dates-with-slots (YYYY-MM-DD)"
                      },
                      "date": { 
                        "type": "string", 
                        "description": "Appointment date for reserve (YYYY-MM-DD)" 
                      },
                      "time": {
                        "type": "string",
                        "description": "Appointment time for reserve (HH:mm, e.g., '14:30')"
                      },
                      "serviceId": { 
                        "type": "string",
                        "description": "Service/treatment ID (filter for availability or required for reserve)"
                      },
                      "medicId": { 
                        "type": "string",
                        "description": "Medic ID (filter for availability or optional for reserve)"
                      },
                      "duration": {
                        "type": "number",
                        "description": "Service duration in minutes (optional for reserve)"
                      },
                      "customer": {
                        "type": "object",
                        "description": "Customer details for reserve",
                        "properties": {
                          "name": { "type": "string", "description": "Patient name" },
                          "email": { "type": "string", "description": "Patient email (required for confirmation)" },
                          "phone": { "type": "string", "description": "Patient phone number" }
                        }
                      },
                      "appointmentId": {
                        "type": "string",
                        "description": "Appointment ID for cancel-appointment"
                      },
                      "patientId": {
                        "type": "string",
                        "description": "Patient ID for cancel-appointment"
                      },
                      "accessCode": {
                        "type": "string",
                        "description": "6-digit patient access code for cancel-appointment"
                      }
                    }
                  }
                }
              },
              "examples": {
                "checkAvailability": {
                  "summary": "Check available dates and time slots",
                  "value": {
                    "businessId": "B0100001",
                    "locationId": "L0100001",
                    "action": "available-dates-with-slots",
                    "params": {
                      "from": "2025-10-17",
                      "to": "2025-10-30",
                      "serviceId": "T0100001"
                    }
                  }
                },
                "createBooking": {
                  "summary": "Create appointment reservation",
                  "value": {
                    "businessId": "B0100001",
                    "locationId": "L0100001",
                    "action": "reserve",
                    "params": {
                      "date": "2025-10-20",
                      "time": "14:30",
                      "serviceId": "T0100001",
                      "medicId": "M0100001",
                      "customer": {
                        "name": "Ion Popescu",
                        "email": "ion@example.com",
                        "phone": "0712345678"
                      }
                    }
                  }
                },
                "cancelAppointment": {
                  "summary": "Cancel patient appointment",
                  "value": {
                    "businessId": "B0100001",
                    "locationId": "L0100001",
                    "action": "cancel-appointment",
                    "params": {
                      "appointmentId": "A0100123",
                      "patientId": "P0100045",
                      "accessCode": "123456"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": { "200": { "description": "Successful operation" } }
      }
    }
  }
}
